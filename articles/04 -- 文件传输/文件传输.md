# 文件传输

[^tag]: linux



## SFTP

基于 **ssh**，命令行文件**管理**器

>   [!note]
>
>   仅进行文件传输可以使用轻量的 `scp`



### 安装 ssh



```shell
sudo pacman -S --noconfirm openssh  # Archlinux
sudo apt install openssh-server  # ubuntu/debian
sudo dnf install openssh-server  # fedora
```



对于 NixOS，安装 ssh 有三种方法

*   方法一：使用 nix-shell 临时安装

    ```shell
    sudo nix-shell -p openssh
    ```

*   方法二：在 Configuration 中配置

    ```nix
      environment.systemPackages = [
        pkgs.openssh
      ];
    ```

*   方法三：使用 nix-env 安装（不推荐）

    ```shell
    sudo nix-env -iA nixos.openssh  # Not recommended
    ```



### 连接服务端

```shell
sftp <user_name>@<host_ipaddress>
```

连接到服务端后会进入一个 `sftp>` **提示符**

* `ls`：列出服务端文件

* `lls`：列出客户端文件

* `cd`：切换服务端目录

* `lcd`：切换客户端目录

* `get <file_name>`：从服务端下载文件
    * `get -r <file_name>`：递归下载

* `put <file_name>`：从服务端上传文件

    * `put -r <file_name>`：递归上传
* `exit`：退出
* `pwd` `mkdir/rmdir` `rm` `rename` `ln` `chmod/chgrp`

使用**命令进**行传输：

```shell
sftp [-r] <user_name>@<host_ipaddress>:/path/to/file /path/to/folder
```



### 图形化

可以使用如 `termius`、`xftp`、`filezilla` 等进行图形化的应用程序进行文件传输操作

---

## SMB

用于**共享文件**的协议（端口：445）

windows 访问 linux 或 windows 文件首选



### 安装



- archlinux

    ```shell
    sudo pacman -S --noconfirm smaba
    mkdir $HOME/shared  # 创建共享目录
    chmod 777 share/  # 授权
    ```



* nixos
    * 方法一：configuration
    
        ```nix
        environment.systemPackages = with pkgs; [ pkgs.samba ];
        ```
    
    * 方法二：nix shell（临时安装）
    
        ```shell
        sudo nix-shell -p samba4
        ```
    
    * 方法三：nix profile/nix-env（不推荐）
    
        ```shell
        sudo nix profile install nixpkgs#samba4
        # or
        sudo nix-env -iA nixos.samba4
        ```



### 配置



编辑配置文件 `/etc/samba/smb.conf`

```conf
[shared]  # 共享名称
comment = Shared Directory  # 注解
path = /home/<host_username>/shared
public = yes  # 
writable = yes  # 可写
browseable = yes  # 可在网络上查找到
valid users = <smb_username>
```


设置 smb 用户密码

```shell
sudo useradd <smb_username>
sudo smbpasswd -a <smb_username>
```


重启服务

```shell
sudo systemctl restart smbd
```



对于 nixos

```nix
# 启用 Samba 服务
services.samba = {
enable = true;
openFirewall = true;  # 自动打开防火墙端口

settings = {
  global = {
    workgroup = "WORKGROUP";  # 工作组名称
    "server string" = "NixOS Samba Server";  # 服务器描述
    security = "user";  # 用户级别的安全性
    "map to guest" = "bad user";  # 映射无效用户到访客
  };
};

# 共享配置
shares = {
  shared = {
        comment = "Shared Directory";
        path = "/home/nix/shared";
        writeable = "yes";
        browseable = "yes";
        "guest ok" = "no";  # 需要认证
        "valid users" = "samba";
        "create mask" = "0644";
        "directory mask" = "0755";
        "force user" = "nix";  # !!important 否则无写入权限因为目录在/home/nix
        "force group" = "users";
  };
  # public = {
  #   comment = "Public Directory";
  #   path = "/home/nix/public";
  #   browseable = "yes";
  #   "read only" = "no";
  #   "guest ok" = "yes";  # 允许访客访问
  # };
  
  # 创建系统用户和组
  users.groups.samba = {};
  users.users.samba = {
    isSystemUser = true;
    group = "samba";
    description = "Samba user";
  };
  
  environment.systemPackages = with pkgs; [ samba ];
};
```



测试共享访问

```shell
sudo pdbedit -L | grep '^samba'
smbclient //localhost/shared -U <smb_username>
```

---

## NFS

同为**共享文件**的协议。与 SMB 不同，用于远程目录像本地目录一样挂载使用

适合大文件读写场景



### 安装



```nix
environment.systemPackages = [ pkgs.nfs-utils ];
```



### 配置



```nix
{
  services.nfs.server = {
    enable = true;
    exports = ''
      </path/to/shared_directory> <shared_ip>(rw,no_root_squash,no_subtree_check,insecure)
    '';
  };

  system.activationScripts.nfs-setup = ''
    mkdir -p /home/nix/shared
    chmod 777 /home/nix/shared
  '';

  networking.firewall.allowedTCPPorts = [ 2049 111 20048 ];
}
```


测试共享访问

```cmd
mount -e <server_ipaddr>
mount \\<server_ipaddr>\path\to\shared_folder <mounted_floder>
copy testfile <mounted_floder>  # 测试写入
del <mounted_floder>/testfile
copy <mounted_floder>/testfile test  # 测试读取
```


---

## Webdav

基于 **HTTP/HTTPS**，将远程服务端目录挂载到本地，需求为频繁**访问**远程文件



### Apache HTTP Server

安装 apache

```shell
sudo pacman -S apache
```

创建共享文件目录和锁目录

```shell
sudo mkdir -p /srv/http/{webdav,DavLock}
```

更改所有权，以 http 用户和用户组运行

```shell
sudo chown -R http:http /srv/http/webdav /srv/http/DavLock
```

设置目录权限

```shell
sudo chmod -R 775 /srv/http/webdav
```

创建webdav用户

```shell
# 若htdigest找不到，则安装apache-tools
sudo htdigest -c /etc/httpd/conf/webdav.users "<WebDAV Area>" <webdav_user>
```

编写配置文件

```shell
sudo vim /etc/httpd/conf/extra/httpd-webdav.conf
# /etc/httpd/conf/extra/httpd-webdav.conf
# 1. 指定DavLock数据库的位置（用于文件锁）
DavLockDB "/srv/http/DavLock/DavLock.db"

# 2. 设置URL别名：将浏览器访问的 `/webdav` 路径映射到服务器的 `/srv/http/webdav` 目录
Alias /webdav "/srv/http/webdav"

# 3. 针对该目录进行详细的权限和功能配置
<Directory "/srv/http/webdav">
    # 核心：启用WebDAV功能
    DAV On

    # 可选：启用目录列表索引。如果关闭，空目录会显示403 Forbidden。
    Options Indexes

    # --- 认证配置 --- 
    # 使用摘要认证（比Basic更安全）
    AuthType Digest
    # 认证领域名称，必须与创建用户时使用的领域完全一致！
    AuthName "WebDAV Area"
    # 指定用户密码文件的路径
    AuthUserFile /etc/httpd/conf/webdav.users
    # 指定摘要认证的提供者为文件
    AuthDigestProvider file

    # --- 授权配置 ---
    # 要求是有效用户才能访问（即密码文件里存在的用户）
    Require valid-user

    # 4. 精细化权限控制：对除了GET和OPTIONS之外的所有方法（如PUT, DELETE, MKCOL等）都要求认证
    # 这意味着匿名用户可以浏览文件列表（GET）和检查服务器支持的方法（OPTIONS），但不能修改。
    # 如果希望所有操作都需要登录，可以删除或注释掉这个<LimitExcept>块。
    <LimitExcept GET OPTIONS>
        Require valid-user
    </LimitExcept>
</Directory>
```

启用模块

```shell
sudo vim /etc/httpd/conf/httpd.conf
ServerName localhost:80
Listen 80
LoadModule dav_module modules/mod_dav.so
LoadModule dav_fs_module modules/mod_dav_fs.so
LoadModule auth_digest_module modules/mod_auth_digest.so
LoadModule authn_file_module modules/mod_authn_file.so
LoadModule authz_core_module modules/mod_authz_core.so
LoadModule authz_user_module modules/mod_authz_user.so
Include conf/extra/httpd-webdav.conf
```

启动webdav

```shell
sudo systemctl enable --now httpd
```

测试服务

```shell
curl -X PROPFIND -u <webdav_user> http://localhost:80/webdav/
```



挂载：`dav://host_ip:port/webdav`

---

## 常用文件传输应用程序

*   同局域网：

    *   [LocalSend](https://localsend.org/zh-CN/download)

        开源跨平台无需注册

    *   [LANDrop](https://landrop.app/)

        开源跨平台无需注册

    *   [wormhole](https://wormhole.app/)

        开源跨平台无需注册

*   非局域网：

    *   [Blip](https://blip.net/)

        非开源但免费，需要注册

    *   [deltachat](https://delta.chat/zh_CN/)

        开源跨平台，去中心化的安全聊天软件，适合传输小文件和文本信息

    *   [Tailscale](https://tailscale.com/)

        开源跨平台，虽然不专用于文件传输，但用途多样，可以进行异地组网、内网穿透、全隧道搭建等
